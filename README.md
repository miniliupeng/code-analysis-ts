# 背景 复杂的现代前端架构

API 文档无法表述真实的依赖关系

## 问题

- 基础架构团队，不清楚UI库在业务团队的使用情况，不敢轻易修改和升级，只能向后兼容，导致框架越发臃肿
- A、B 应用项目直接使用 document.cookie 去设置 cookie，而非基础框架提供的带隔离 namespace 特性的 cookie API，导致 cookie 相互污染
- C 应用团队代码一直未更新必须升级的框架基础 API，发布 live 后因特定条件执行报错才被发现
- D 应用团队私自重写了基础项目的某个 API，基础架构团队对此并不知晓，通过线上报错才得以发现

## 解决方案  前端代码分析工具

通过扫描业务团队单个或全部项目，找出所有需要分析的代码文件（TS、Vue、JS），并依次将其解析为 AST ，然后遍历各级 AST 节点，按照分析指标对 API 调用进行定位/统计/标记等处理，等分析完所有文件后，整理输出分析结果。分析工具会以 npm 包形式管理，支持多种接入方式，可以快速集成到其它工具或服务中。

## 依赖调用分析到底要做些什么

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5006d7445b024d01a77cae155f9a74ff~tplv-k3u1fbpfcp-jj-mark:1512:0:0:0:q75.awebp" width="500" height="500" alt="替代文本">

简单来说，首先针对每一个需要分析的 TS(JS) 文件：

- 遍历其所有 import 节点（上图绿框区域），分析并记录从目标依赖引入的 API 信息，并排除非目标依赖项的干扰。

- 判定引入的 API 在具体代码中（上图红框区域）是否有调用，过程中还需要排除局部同名变量等一系列干扰。

- 根据分析指标如用途识别（类型、属性、方法）等对该 API 调用进行指标判定分析，命中则记录到指定 Map 中。

然后按照上面的步骤依次遍历所有项目中指定的 TS(JS) 文件，就可以得到全部应用对于特定依赖（如：framework）的 API 调用分析数据了，最后根据使用场景（告警、评分、代码报告、代码建议等）对分析数据进行标记，二次整理，即可输出最终的分析结果。


# AST

## 定义

抽象语法树 (Abstract Syntax Tree)，简称 AST，它是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。

## 常见节点类型

- literal(字面量) 
- Identifier(标识符)
- Declaration(声明)
- Statement(语句)
- Expression(表达式)
- Import导入模块
- Export导出模块

公共属性

- pos 索引的起始位置
- end 索引的结束位置
- kind 节点的类型

## 可视化工具
- AST explorer
- TypeScript AST Viewer  除了展示 AST 节点信息外，还会关联节点 TS 编译过程中的 type、symbol 等信息

## 用途

- 代码编译
  - Babel
  - TypeScript
  - Sass

- 代码加工
  - Prettier 代码美化，风格格式化
  - EsLint 修复语法错误
  - uglifyJS 代码压缩，混淆

- 代码分析
  - EsLint 代码语法检查
  - Webpack 代码模块打包分析

## 基于 AST 的代码处理工具

- Parsing（解析） ：这个过程由编译器实现，会经过词法分析和语法分析两个过程，生成 AST 。

- Traversing（遍历）： 深度优先遍历 AST ，访问树上各个节点的信息（Node）。

- Transforming（修改）： 在遍历的过程中可对节点信息进行修改/转化，生成新的 AST 。

- Printing（输出）： 将转化后新的 AST 输出成新的代码块。

## AST 如何生成

- 词法分析：将整个代码字符串分割成最小语法单元数组（Tokens）。

- 语法分析：在分词基础上建立分析语法单元之间的关系。